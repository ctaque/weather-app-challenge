#cloud-config
# PlanMyTrip Tpp droplet cloud-init configuration for Rocky Linux 9
# Installs and configures: PostgreSQL, Redis, nginx, Node.js
# Variables interpolated by Terraform templatefile
# Updated: 2026-01-23 - Fixed character encoding issues

package_update: true
package_upgrade: false

users:
  - name: planmytrip
    shell: /bin/bash
    groups: wheel
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  # PostgreSQL init script
  - path: /tmp/init-postgres.sql
    owner: root:root
    permissions: "0644"
    content: |
      -- Create user
      CREATE USER ${db_username} WITH PASSWORD '${db_password}';

      -- Create database
      CREATE DATABASE ${db_name} OWNER ${db_username};

      -- Grant privileges
      GRANT ALL PRIVILEGES ON DATABASE ${db_name} TO ${db_username};
      ALTER USER ${db_username} CREATEDB;

      -- Show result
      \l
      \du

  # Redis configuration
  - path: /etc/redis/planmytrip.conf
    owner: root:root
    permissions: "0644"
    content: |
      # Custom configuration for Planmytrip App
      bind 127.0.0.1
      protected-mode yes
      port 6379
      timeout 0
      tcp-keepalive 300

      # Memory management
      maxmemory 512mb
      maxmemory-policy allkeys-lru

      # Persistence
      save 900 1
      save 300 10
      save 60 10000
      appendonly yes
      appendfsync everysec

      # Logging
      loglevel notice
      logfile /var/log/redis/redis.log

      # Working directory
      dir /var/lib/redis

  # nginx configuration (initial HTTP only, HTTPS configured after certbot)
  - path: /etc/nginx/conf.d/planmytrip.conf
    owner: root:root
    permissions: "0644"
    content: |
      upstream backend {
          server 127.0.0.1:3000;
      }

      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          server_name ${domain_name};

          client_max_body_size 10M;

          # Logs
          access_log /var/log/nginx/planmytrip-access.log;
          error_log /var/log/nginx/planmytrip-error.log;

          # Let's Encrypt ACME challenge
          location /.well-known/acme-challenge/ {
              root /var/www/html;
          }

          # Proxy vers Node.js backend
          location / {
              proxy_pass http://backend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;

              # Timeouts
              proxy_connect_timeout 60s;
              proxy_send_timeout 60s;
              proxy_read_timeout 60s;
          }

          # Cache pour assets statiques
          location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
              proxy_pass http://backend;
              expires 1y;
              add_header Cache-Control "public, immutable";
          }
      }

  # Git credentials helper script for cloning private repos
  - path: /tmp/git-credential-helper.sh
    owner: root:root
    permissions: "0700"
    content: |
      #!/bin/bash
      echo "username=git"
      echo "password=${github_token}"

  # Systemd service for planmytrip
  - path: /tmp/planmytrip.service
    owner: root:root
    permissions: "0644"
    content: |
      [Unit]
      Description=Trip plannning App Rust Application
      After=network.target postgresql.service redis.service
      Wants=postgresql.service redis.service

      [Service]
      Type=simple
      User=planmytrip
      Group=planmytrip
      WorkingDirectory=/home/planmytrip/app

      # Variables d'environnement
      EnvironmentFile="/etc/planmytrip/.env"

      # Commande de démarrage (npm sera trouvé via PATH)
      ExecStart=./actix_sqlx_template

      # Redémarrage automatique
      Restart=always
      RestartSec=10

      # Logs vers journald (consultables avec journalctl -u planmytrip)
      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier=planmytrip

      [Install]
      WantedBy=multi-user.target

  # Deployment script
  - path: /tmp/deploy.sh
    owner: root:root
    permissions: "0755"
    content: |
      #!/bin/bash
      set -e

      echo "=> Starting deployment..."

      # Update .env from planMyTrip repository
      echo "=> Updating .env configuration..."
      cd /home/planmytrip/planMyTrip
      git pull origin main
      cp .env /etc/planmytrip/.env
      echo "=> .env updated"

      # Pull latest application code
      cd /home/planmytrip/app
      echo "=> Pulling latest changes..."
      git pull origin main

      # Install all dependencies (including devDependencies for build)
      echo "=> Installing dependencies..."
      pnpm install

      # Build frontend
      echo "=> Building frontend..."
      pnpm run build

      # Remove devDependencies after build to save space
      echo "=> Cleaning devDependencies..."
      pnpm prune --prod

      # Restart app
      echo "=> Applying restorecon..."
      /sbin/restorecon -v /etc/systemd/system/planmytrip.service
      echo "=> Restarting application..."
      sudo systemctl restart planmytrip

      # Show status
      sudo systemctl status planmytrip --no-pager

      echo "=> Deployment complete!"

  # Database backup script
  - path: /tmp/backup-db.sh
    owner: root:root
    permissions: "0755"
    content: |
      #!/bin/bash
      BACKUP_DIR="/home/planmytrip/backups"
      TIMESTAMP=$(date +%Y%m%d-%H%M%S)
      mkdir -p $BACKUP_DIR

      echo "Starting PostgreSQL backup..."
      PGPASSWORD="${db_password}" pg_dump -h localhost -U ${db_username} ${db_name} > $BACKUP_DIR/db-backup-$TIMESTAMP.sql

      if [ $? -eq 0 ]; then
          echo "[OK] Backup saved to $BACKUP_DIR/db-backup-$TIMESTAMP.sql"

          # Keep only last 7 backups
          ls -t $BACKUP_DIR/db-backup-*.sql 2>/dev/null | tail -n +8 | xargs -r rm
          echo "[OK] Old backups cleaned (keeping last 7)"
      else
          echo "[ERROR] Backup failed!"
          exit 1
      fi

runcmd:
  # Ensure SSH packages are installed and protected FIRST
  - echo "==> Protecting SSH packages..."
  - dnf install -y openssh-server openssh-clients
  - dnf install -y python3-dnf-plugin-versionlock || true
  - dnf versionlock add openssh-server openssh-clients || echo "Versionlock not available, skipping"
  - systemctl enable sshd
  - systemctl start sshd
  - systemctl status sshd --no-pager
  - echo "[OK] SSH packages secured, locked, and started"

  # Copy SSH keys to planmytrip (will be created by cloud-init)
  - echo "==> Setting up SSH keys for planmytrip user..."
  - mkdir -p /home/planmytrip/.ssh
  - cp /root/.ssh/authorized_keys /home/planmytrip/.ssh/authorized_keys || echo "No root authorized_keys to copy"
  - chown -R planmytrip:planmytrip /home/planmytrip/.ssh
  - chmod 700 /home/planmytrip/.ssh
  - chmod 600 /home/planmytrip/.ssh/authorized_keys || true
  - echo "[OK] SSH keys copied to planmytrip user"

  # Disable firewalld to avoid conflicts with DigitalOcean firewall
  - echo "==> Disabling firewalld (using DigitalOcean firewall instead)..."
  - systemctl stop firewalld || true
  - systemctl disable firewalld || true
  - echo "[OK] firewalld disabled"

  # Install EPEL and packages
  - echo "==> Installing EPEL repository..."
  - dnf install -y epel-release
  - echo "[OK] EPEL installed"

  # Install base packages (removed firewalld since we don't use it)
  - echo "==> Installing base packages..."
  - dnf install -y git curl wget ca-certificates gnupg python3-pip
  - echo "[OK] Base packages installed"

  # Install development tools
  - echo "==> Installing development tools..."
  - dnf groupinstall -y "Development Tools" || echo "Development Tools partially installed"
  - echo "[OK] Development tools installed"

  # Verify SSH is still installed after Development Tools
  - echo "==> Verifying SSH packages after Development Tools installation..."
  - dnf install -y openssh-server openssh-clients
  - systemctl is-active sshd || systemctl start sshd
  - echo "[OK] SSH packages verified and running"

  # Install PostgreSQL
  - echo "==> Installing PostgreSQL..."
  - dnf install -y postgresql-server postgresql-contrib
  - echo "[OK] PostgreSQL installed"

  # Install nginx
  - echo "==> Installing nginx..."
  - dnf install -y nginx
  - echo "[OK] nginx installed"

  # Install certbot for Let's Encrypt
  - echo "==> Installing certbot..."
  - dnf install -y certbot python3-certbot-nginx
  - echo "[OK] certbot installed"

  # Install Redis from EPEL
  - echo "==> Installing Redis from EPEL..."
  - dnf install -y redis
  - echo "[OK] Redis installed"

  # Configure SELinux for nginx proxy
  - echo "==> Configuring SELinux..."
  - setsebool -P httpd_can_network_connect 1
  - echo "[OK] SELinux configured for nginx proxy"

  # Initialize and configure PostgreSQL
  - echo "==> Initializing PostgreSQL..."
  - /usr/bin/postgresql-setup --initdb --unit postgresql || echo "PostgreSQL already initialized"
  - systemctl enable postgresql
  - systemctl start postgresql
  - sleep 5
  - systemctl status postgresql --no-pager

  # Configure PostgreSQL authentication
  - echo "==> Configuring PostgreSQL authentication..."
  - sed -i 's/ident$/md5/' /var/lib/pgsql/data/pg_hba.conf
  - sed -i 's/peer$/md5/' /var/lib/pgsql/data/pg_hba.conf
  - systemctl restart postgresql
  - sleep 3

  # Create PostgreSQL user and database
  - echo "==> Creating PostgreSQL database and user..."
  - sudo -u postgres psql -f /tmp/init-postgres.sql
  - echo "[OK] PostgreSQL configured"

  # Configure Redis
  - echo "==> Configuring Redis..."
  - mkdir -p /var/log/redis /var/lib/redis
  - cp /etc/redis/planmytrip.conf /etc/redis/redis.conf
  - chown -R redis:redis /var/log/redis /var/lib/redis /etc/redis
  - systemctl enable redis
  - systemctl start redis
  - sleep 2
  - systemctl status redis --no-pager
  - echo "[OK] Redis configured"

  # Configure nginx
  - echo "==> Configuring nginx..."
  - rm -f /etc/nginx/conf.d/default.conf
  - /usr/sbin/nginx -t || echo "nginx config test failed"
  - systemctl enable nginx
  - systemctl start nginx
  - sleep 2
  - systemctl status nginx --no-pager
  - echo "[OK] nginx configured"

  # Firewall is managed by DigitalOcean (see main.tf)
  # firewalld is disabled to avoid conflicts

  # Install Node.js 20.x from NodeSource
  - echo "==> Installing Node.js 20.x..."
  - curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
  - dnf install -y nodejs
  - node --version
  - npm --version
  - echo "[OK] Node.js installed"

  # Install pnpm globally
  - echo "==> Installing pnpm..."
  - npm install -g pnpm
  - echo "[OK] pnpm installed"

  # Verify npm path and create symlink if needed
  - echo "==> Verifying npm installation..."
  - which npm
  - npm --version
  - |
    if [ ! -f /usr/bin/npm ]; then
      NPM_PATH=$(which npm)
      if [ -n "$NPM_PATH" ]; then
        ln -sf $NPM_PATH /usr/bin/npm
        echo "Created symlink: /usr/bin/npm -> $NPM_PATH"
      fi
    fi
  - echo "[OK] npm path verified"
  # Create directories and move temp files
  - echo "==> Creating application directories..."
  - mkdir -p /home/planmytrip/logs
  - mkdir -p /home/planmytrip/backups
  - mv /tmp/deploy.sh /home/planmytrip/deploy.sh
  - mv /tmp/backup-db.sh /home/planmytrip/backup-db.sh

  # Move and verify service file
  - echo "==> Installing systemd service..."
  - mv /tmp/planmytrip.service /etc/systemd/system/planmytrip.service
  - chmod 644 /etc/systemd/system/planmytrip.service
  - ls -lh /etc/systemd/system/planmytrip.service
  - echo "[OK] Service file installed"

  # Clone and setup application
  - echo "==> Cloning application repository..."
  - |
    sudo -u planmytrip bash << 'APP_SETUP_EOF'
    cd /home/planmytrip

    # Clone repository if not exists
    if [ ! -d app/.git ]; then
        echo "Cloning repository..."
        rm -rf app
        git clone https://github.com/ctaque/weather-app-challenge.git app
        echo "Repository cloned successfully"
    else
        echo "Repository already exists, pulling latest changes..."
        cd app
        git pull origin main
        cd /home/planmytrip
    fi

    cd app

    # Install dependencies
    echo "Installing dependencies..."
    pnpm install --prod

    # Build frontend
    echo "Building frontend..."
    pnpm run build

    echo "Application built successfully!"
    APP_SETUP_EOF

  # Clone private .env repository and configure environment
  - echo "==> Cloning .env repository..."
  - |
    sudo -u planmytrip bash << 'ENV_SETUP_EOF'
    cd /home/planmytrip

    # Configure git credential helper
    git config --global credential.helper "store --file ~/.git-credentials"
    echo "https://git:${github_token}@github.com" > ~/.git-credentials
    chmod 600 ~/.git-credentials

    # Clone .env repository
    if [ ! -d planMyTrip/.git ]; then
        echo "Cloning planMyTrip repository..."
        rm -rf planMyTrip
        git clone https://github.com/ctaque/planMyTrip.git planMyTrip
        echo ".env repository cloned successfully"
    else
        echo ".env repository already exists, pulling latest changes..."
        cd planMyTrip
        git pull origin main
        cd /home/planmytrip
    fi

    # Copy .env file to app directory
    if [ -f planMyTrip/.env ]; then
        cp planMyTrip/.env app/.env
        echo ".env file configured from planMyTrip repository"
    else
        echo "WARNING: .env file not found in planMyTrip repository!"
        exit 1
    fi

    # Clean up credentials
    rm -f ~/.git-credentials
    git config --global --unset credential.helper

    echo ".env configuration complete!"
    ENV_SETUP_EOF

  # Set proper permissions for application files
  - echo "==> Setting application permissions..."
  - chown -R planmytrip:planmytrip /home/planmytrip

  # Enable and start the planmytrip service
  - echo "==> Starting planmytrip service..."
  - echo "Reloading systemd daemon..."
  - systemctl daemon-reload
  - echo "Checking if service is recognized..."
  - 'systemctl list-unit-files | grep planmytrip || echo "WARNING: Service not found"'
  - echo "Enabling service..."
  - systemctl enable planmytrip.service
  - echo "Starting service..."
  - 'systemctl start planmytrip.service || echo "WARNING: Failed to start"'
  - sleep 3
  - echo "Service status:"
  - "systemctl status planmytrip.service --no-pager || journalctl -u planmytrip.service -n 50 --no-pager"
  - echo "[OK] Service configuration complete"

  # Configure Let's Encrypt SSL certificate
  - echo "==> Configuring Let's Encrypt SSL..."
  - mkdir -p /var/www/html/.well-known/acme-challenge
  - |
    if [ "${domain_name}" != "" ]; then
      echo "Waiting 30 seconds for DNS propagation..."
      sleep 30

      echo "Obtaining SSL certificate for ${domain_name}..."
      certbot --nginx -d ${domain_name} --non-interactive --agree-tos --email admin@${domain_name} --redirect || echo "Failed to obtain SSL certificate. Domain may not be pointing to this server yet. Run manually: certbot --nginx -d ${domain_name}"

      # Test automatic renewal (if certificate was obtained)
      if [ -f /etc/letsencrypt/live/${domain_name}/fullchain.pem ]; then
        echo "Testing automatic renewal..."
        certbot renew --dry-run || echo "Renewal test failed, but will retry later"
      fi

      # Ensure certbot timer is enabled for auto-renewal (primary method)
      systemctl enable certbot-renew.timer
      systemctl start certbot-renew.timer
      systemctl status certbot-renew.timer --no-pager || echo "Timer status check completed"

      echo "[OK] SSL certificate configured for ${domain_name}"
    else
      echo "[SKIP] No domain name configured, skipping SSL setup"
    fi

  # Setup cron jobs
  - echo "==> Setting up cron jobs..."
  # Daily database backup at 2 AM
  - (crontab -u planmytrip -l 2>/dev/null; echo "0 2 * * * /home/planmytrip/backup-db.sh >> /home/planmytrip/logs/backup.log 2>&1") | crontab -u planmytrip -
  # Certbot renewal check twice daily at 3:30 AM and 3:30 PM (fallback if systemd timer fails)
  - (crontab -l 2>/dev/null; echo "30 3,15 * * * certbot renew --quiet --deploy-hook 'systemctl reload nginx' >> /var/log/certbot-cron.log 2>&1") | crontab -

  # Final SSH verification
  - echo ""
  - echo "==> Final SSH verification..."
  - rpm -qa | grep openssh
  - systemctl is-active sshd || systemctl start sshd
  - ss -tlnp | grep :22 || echo "Port 22 check complete"
  - echo "[OK] SSH verified and running"

  # Service status
  - echo ""
  - echo "==> Service Status:"
  - echo "SSH:" $(systemctl is-active sshd)
  - echo "PostgreSQL:" $(systemctl is-active postgresql)
  - echo "Redis:" $(systemctl is-active redis)
  - echo "nginx:" $(systemctl is-active nginx)
  - echo "Planmytrip:" $(systemctl is-active planmytrip)
  - 'echo "Firewall: Managed by DigitalOcean"'
  - echo ""

  # Write completion marker
  - echo "$(date) - PlanMyTrip App provisioning completed successfully" >> /var/log/cloud-init-complete.log
  - echo "[OK] PlanMyTrip App droplet provisioning complete!"

final_message: |
  ==========================================
  PlanMyTrip App droplet is ready! (Rocky Linux 9)
  ==========================================
  Services running:
    - SSH (port 22)
    - PostgreSQL (localhost:5432)
    - Redis (localhost:6379)
    - nginx (ports 80/443 with SSL)
    - Firewall: Managed by DigitalOcean
    - Let's Encrypt SSL (auto-renewal enabled)

  SSH Access:
    - ssh root@YOUR_DROPLET_IP
    - ssh planmytrip@YOUR_DROPLET_IP

  Useful commands:
    - Check app status: systemctl status planmytrip
    - View logs: journalctl -u planmytrip -f
    - Restart app: systemctl restart planmytrip
    - Deploy updates: /home/planmytrip/deploy.sh
    - Backup database: /home/planmytrip/backup-db.sh
    - Check SSL certificate: certbot certificates
    - Renew SSL manually: certbot renew
    - Check cloud-init logs: tail -f /var/log/cloud-init-output.log
  ==========================================
