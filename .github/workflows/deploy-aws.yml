# GitHub Actions - Déploiement automatique sur AWS
#
# Configuration:
# 1. Ajouter les secrets dans GitHub Settings > Secrets:
#    - AWS_ACCESS_KEY_ID
#    - AWS_SECRET_ACCESS_KEY
#    - EC2_SSH_PRIVATE_KEY (contenu du .pem)
#    - EC2_HOST (IP publique de l'EC2)
#
# 2. Renommer ce fichier: mv deploy-aws.yml.example deploy-aws.yml
#
# 3. Push vers main pour déclencher le déploiement

name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch: # Permet déclenchement manuel

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10"

jobs:
  # Job 1: Build et test
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Job 2: Déployer sur EC2
  deploy-ec2:
    name: Deploy to EC2
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check EC2 configuration
        id: check-secrets
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ] || [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo ""
            echo "ℹ️  EC2 deployment is not configured"
            echo ""
            echo "To enable EC2 deployment, add these secrets in GitHub Settings:"
            echo "  Settings > Secrets and variables > Actions > New repository secret"
            echo ""
            echo "Required secrets:"
            echo "  - EC2_HOST: Your EC2 instance public IP or hostname"
            echo "  - EC2_SSH_PRIVATE_KEY: Content of your .pem key file"
            echo ""
            echo "Build artifacts are available for manual deployment."
            echo ""
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Download build artifacts
        if: steps.check-secrets.outputs.configured == 'true'
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Setup SSH
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        if: steps.check-secrets.outputs.configured == 'true'
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          # Créer archive
          tar -czf app.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=terraform \
            .

          # Upload vers EC2
          scp -i ~/.ssh/deploy_key.pem app.tar.gz ec2-user@$EC2_HOST:/tmp/

          # Déployer sur EC2
          ssh -i ~/.ssh/deploy_key.pem ec2-user@$EC2_HOST << 'ENDSSH'
            set -e

            # Devenir weatherapp user
            sudo -u weatherapp bash << 'EOF'
              cd /home/weatherapp/app

              # Backup actuel
              tar -czf /home/weatherapp/backups/app-$(date +%Y%m%d-%H%M%S).tar.gz .

              # Extraire nouvelle version
              tar -xzf /tmp/app.tar.gz

              # Installer dépendances
              pnpm install --prod

              # Build frontend
              pnpm run build

              # Redémarrer avec PM2
              pm2 restart ecosystem.config.js --update-env

              # Vérifier
              sleep 5
              pm2 status
          EOF
          ENDSSH

      - name: Health check
        if: steps.check-secrets.outputs.configured == 'true'
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          # Attendre que l'app démarre
          sleep 10

          # Test HTTP
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_HOST)

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "304" ]; then
            echo "✅ Deployment successful! HTTP $HTTP_CODE"
          else
            echo "❌ Deployment failed! HTTP $HTTP_CODE"
            exit 1
          fi

  # Job 3: Déployer sur S3 (optionnel)
  deploy-s3:
    name: Deploy to S3
    needs: build
    runs-on: ubuntu-latest
    if: false # Mettre à true pour activer

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-3

      - name: Sync to S3
        run: |
          # Récupérer le nom du bucket
          BUCKET_NAME=$(aws s3 ls | grep weather-app-assets | awk '{print $3}')

          # Upload vers S3
          aws s3 sync dist/ s3://$BUCKET_NAME/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "index.html"

          # index.html sans cache
          aws s3 cp dist/index.html s3://$BUCKET_NAME/index.html \
            --cache-control "no-cache, no-store, must-revalidate"

  # Job 4: Notification
  notify:
    name: Notify
    needs: [build, deploy-ec2]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment status
        run: |
          BUILD_RESULT="${{ needs.build.result }}"
          DEPLOY_RESULT="${{ needs.deploy-ec2.result }}"

          echo "Build result: $BUILD_RESULT"
          echo "Deploy result: $DEPLOY_RESULT"

          if [ "$BUILD_RESULT" == "success" ]; then
            echo "✅ Build succeeded!"
          else
            echo "❌ Build failed!"
            exit 1
          fi

          if [ "$DEPLOY_RESULT" == "success" ]; then
            echo "✅ EC2 deployment succeeded!"
          elif [ "$DEPLOY_RESULT" == "skipped" ]; then
            echo "⏭️  EC2 deployment skipped (secrets not configured)"
          else
            echo "❌ EC2 deployment failed!"
            exit 1
          fi

      # Optionnel: Envoyer notification Slack/Discord
      # - name: Slack notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
